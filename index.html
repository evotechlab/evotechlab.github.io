<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>FieldCam Mobile</title>

<style>
:root{
  --bg:#111;
  --panel:#1c1c1c;
  --border:#2a2a2a;
  --accent:#d6a800;
  --text:#eaeaea;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  padding:1rem;
  text-align:center;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  font-weight:600;
}

#camera{
  flex:1;
  background:#000;
  position:relative;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
}

#previewBar{
  display:flex;
  gap:.6rem;
  padding:.6rem;
  overflow-x:auto;
  background:var(--panel);
  border-top:1px solid var(--border);
}

.thumb{
  height:70px;
  aspect-ratio:4/3;
  object-fit:cover;
  border:1px solid var(--border);
  border-radius:4px;
}

.controls{
  display:flex;
  gap:.6rem;
  padding:.8rem;
  background:var(--panel);
  border-top:1px solid var(--border);
}

button{
  flex:1;
  padding:.9rem;
  border:none;
  border-radius:6px;
  font-weight:600;
  font-size:1rem;
  cursor:pointer;
}

.primary{
  background:var(--accent);
  color:#000;
}

.secondary{
  background:#2a2a2a;
  color:var(--text);
  border:1px solid var(--border);
}

</style>
</head>

<body>

<header>FieldCam – Mobile Dropbox</header>

<div id="camera">
  <video id="video" autoplay playsinline></video>
</div>

<div id="previewBar"></div>

<div class="controls">
  <button class="primary" id="shoot">Scatta</button>
  <button class="secondary" id="uploadBtn">Invia</button>
</div>

<script>

/* ================= CONFIG ================= */

const DROPBOX_APP_KEY = "0kimqzc29he9w1u";
const DROPBOX_FOLDER = "/FieldCam";

const STORAGE_PREFIX = "fieldcam_";

let shots = [];
let accessToken = localStorage.getItem(STORAGE_PREFIX+"access");
let refreshToken = localStorage.getItem(STORAGE_PREFIX+"refresh");

const video = document.getElementById("video");
const shootBtn = document.getElementById("shoot");
const uploadBtn = document.getElementById("uploadBtn");
const previewBar = document.getElementById("previewBar");

/* ================= CAMERA ================= */

async function initCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" },
      audio:false
    });
    video.srcObject = stream;
  }catch(err){
    alert("Errore accesso camera: "+err.message);
  }
}

initCamera();

/* ================= SCATTA ================= */

shootBtn.onclick = ()=>{
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0);

  canvas.toBlob(blob=>{
    const name = "fieldcam_"+Date.now()+".jpg";
    shots.push({name,blob});
    addThumb(blob);
  },"image/jpeg",0.9);
};

function addThumb(blob){
  const img = document.createElement("img");
  img.src = URL.createObjectURL(blob);
  img.className="thumb";
  previewBar.appendChild(img);
}

/* ================= PKCE ================= */

function base64UrlEncode(arrayBuffer){
  return btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
    .replace(/\+/g,"-")
    .replace(/\//g,"_")
    .replace(/=+$/,"");
}

async function sha256(plain){
  const encoder=new TextEncoder();
  const data=encoder.encode(plain);
  return await crypto.subtle.digest("SHA-256",data);
}

async function generatePKCE(){
  const verifier=base64UrlEncode(crypto.getRandomValues(new Uint8Array(32)));
  const challenge=base64UrlEncode(await sha256(verifier));
  localStorage.setItem(STORAGE_PREFIX+"verifier",verifier);
  return challenge;
}

/* ================= LOGIN ================= */

async function loginDropbox(){
  const challenge=await generatePKCE();
  const redirectUri=window.location.origin+window.location.pathname;

  const url=
    "https://www.dropbox.com/oauth2/authorize"+
    "?client_id="+DROPBOX_APP_KEY+
    "&response_type=code"+
    "&code_challenge="+challenge+
    "&code_challenge_method=S256"+
    "&token_access_type=offline"+
    "&redirect_uri="+encodeURIComponent(redirectUri);

  window.location.href=url;
}

/* ================= HANDLE REDIRECT ================= */

window.addEventListener("load",async()=>{
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");

  if(code){
    const verifier=localStorage.getItem(STORAGE_PREFIX+"verifier");
    const redirectUri=window.location.origin+window.location.pathname;

    const body=new URLSearchParams({
      code,
      grant_type:"authorization_code",
      client_id:DROPBOX_APP_KEY,
      code_verifier:verifier,
      redirect_uri:redirectUri
    });

    const res=await fetch("https://api.dropbox.com/oauth2/token",{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body
    });

    const data=await res.json();

    accessToken=data.access_token;
    refreshToken=data.refresh_token;

    localStorage.setItem(STORAGE_PREFIX+"access",accessToken);
    localStorage.setItem(STORAGE_PREFIX+"refresh",refreshToken);

    window.history.replaceState({},document.title,window.location.pathname);
  }
});

/* ================= REFRESH ================= */

async function refreshAccessToken(){
  const body=new URLSearchParams({
    grant_type:"refresh_token",
    refresh_token:refreshToken,
    client_id:DROPBOX_APP_KEY
  });

  const res=await fetch("https://api.dropbox.com/oauth2/token",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });

  const data=await res.json();
  accessToken=data.access_token;
  localStorage.setItem(STORAGE_PREFIX+"access",accessToken);
}

/* ================= UPLOAD ================= */

uploadBtn.onclick=uploadAll;

async function uploadAll(){

  if(!shots.length){
    alert("Nessuna foto da inviare.");
    return;
  }

  if(!refreshToken){
    await loginDropbox();
    return;
  }

  uploadBtn.disabled=true;
  uploadBtn.innerText="Invio...";

  await refreshAccessToken();

  for(const shot of shots){
    await fetch("https://content.dropboxapi.com/2/files/upload",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+accessToken,
        "Dropbox-API-Arg":JSON.stringify({
          path:DROPBOX_FOLDER+"/"+shot.name,
          mode:"add",
          autorename:true,
          mute:false
        }),
        "Content-Type":"application/octet-stream"
      },
      body:shot.blob
    });
  }

  shots=[];
  previewBar.innerHTML="";
  uploadBtn.disabled=false;
  uploadBtn.innerText="Invia";

  alert("Upload completato ✔");
}

</script>
</body>
</html>














