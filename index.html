<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FieldCam Dropbox Upload</title>

<style>
body{
  font-family:system-ui;
  background:#111;
  color:#eee;
  text-align:center;
  padding:20px;
}
video{
  width:100%;
  max-width:400px;
  border:2px solid #333;
}
button{
  margin:10px;
  padding:10px 20px;
  font-weight:bold;
}
#preview{
  margin-top:10px;
}
img{
  max-width:150px;
  margin-top:10px;
}
</style>
</head>
<body>

<h2>FieldCam â€“ Dropbox Upload Test</h2>

<video id="video" autoplay playsinline></video>
<br>
<button id="shoot">Scatta Foto</button>
<button id="upload">Upload su Dropbox</button>

<div id="preview"></div>

<script>

/* ==========================
   CONFIGURAZIONE
========================== */

const DROPBOX_APP_KEY = "0kimqzc29he9w1u";
const BASE_FOLDER = "/CANTIERI_TEST"; // dentro App Folder

let accessToken = localStorage.getItem("db_access");
let refreshToken = localStorage.getItem("db_refresh");
let currentBlob = null;

/* ==========================
   CAMERA
========================== */

const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({
  video:{facingMode:"environment"}
})
.then(stream=>video.srcObject=stream)
.catch(err=>alert("Errore camera: "+err));

/* ==========================
   SCATTO FOTO
========================== */

document.getElementById("shoot").onclick = () => {

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0);

  canvas.toBlob(blob=>{
    currentBlob = blob;

    const img = document.createElement("img");
    img.src = URL.createObjectURL(blob);

    const preview = document.getElementById("preview");
    preview.innerHTML="";
    preview.appendChild(img);

  },"image/jpeg",0.9);
};

/* ==========================
   PKCE UTILS
========================== */

function base64UrlEncode(buffer){
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g,"-")
    .replace(/\//g,"_")
    .replace(/=+$/,"");
}

async function sha256(plain){
  return await crypto.subtle.digest("SHA-256",new TextEncoder().encode(plain));
}

/* ==========================
   LOGIN DROPBOX
========================== */

async function loginDropbox(){

  const verifier = base64UrlEncode(
    crypto.getRandomValues(new Uint8Array(32))
  );

  const challenge = base64UrlEncode(await sha256(verifier));
  localStorage.setItem("pkce_verifier",verifier);

  const redirectUri = location.origin + location.pathname;

  const authUrl =
    "https://www.dropbox.com/oauth2/authorize" +
    "?client_id=" + DROPBOX_APP_KEY +
    "&response_type=code" +
    "&code_challenge=" + challenge +
    "&code_challenge_method=S256" +
    "&token_access_type=offline" +
    "&redirect_uri=" + encodeURIComponent(redirectUri);

  window.location.href = authUrl;
}

/* ==========================
   HANDLE REDIRECT
========================== */

window.addEventListener("load", async ()=>{

  const params = new URLSearchParams(location.search);
  const code = params.get("code");

  if(code){

    const verifier = localStorage.getItem("pkce_verifier");
    const redirectUri = location.origin + location.pathname;

    const body = new URLSearchParams({
      code: code,
      grant_type: "authorization_code",
      client_id: DROPBOX_APP_KEY,
      code_verifier: verifier,
      redirect_uri: redirectUri
    });

    const res = await fetch(
      "https://api.dropbox.com/oauth2/token",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/x-www-form-urlencoded"
        },
        body
      }
    );

    const data = await res.json();

    accessToken = data.access_token;
    refreshToken = data.refresh_token;

    localStorage.setItem("db_access", accessToken);
    localStorage.setItem("db_refresh", refreshToken);

    history.replaceState({},document.title,location.pathname);
  }
});

/* ==========================
   REFRESH TOKEN
========================== */

async function refreshAccessToken(){

  const body = new URLSearchParams({
    grant_type:"refresh_token",
    refresh_token:refreshToken,
    client_id:DROPBOX_APP_KEY
  });

  const res = await fetch(
    "https://api.dropbox.com/oauth2/token",
    {
      method:"POST",
      headers:{
        "Content-Type":"application/x-www-form-urlencoded"
      },
      body
    }
  );

  const data = await res.json();

  accessToken = data.access_token;
  localStorage.setItem("db_access",accessToken);
}

/* ==========================
   BUILD PATH
========================== */

function buildPath(){

  const today = new Date().toISOString().split("T")[0];
  const fileName = "IMG_" + Date.now() + ".jpg";

  return BASE_FOLDER + "/" +
         today + "/" +
         fileName;
}

/* ==========================
   UPLOAD
========================== */

document.getElementById("upload").onclick = async ()=>{

  if(!currentBlob){
    alert("Scatta prima una foto.");
    return;
  }

  if(!refreshToken){
    await loginDropbox();
    return;
  }

  await refreshAccessToken();

  const path = buildPath();

  console.log("UPLOAD PATH:", path);

  const response = await fetch(
    "https://content.dropboxapi.com/2/files/upload",
    {
      method:"POST",
      headers:{
        "Authorization":"Bearer "+accessToken,
        "Dropbox-API-Arg": JSON.stringify({
          path:path,
          mode:"add",
          autorename:true,
          mute:false
        }),
        "Content-Type":"application/octet-stream"
      },
      body:currentBlob
    }
  );

  const text = await response.text();

  if(!response.ok){
    console.error("UPLOAD ERROR:", text);
    alert("Errore upload. Controlla console.");
  } else {
    console.log("SUCCESS:", text);
    alert("Upload completato!");
  }
};

</script>

</body>
</html>












